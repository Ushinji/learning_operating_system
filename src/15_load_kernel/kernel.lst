     1                                  %include "../include/define.s"
     1                              <1>     BOOT_LOAD        equ    0x7C00                  ; ブートプログラムのロード位置
     2                              <1>     BOOT_SIZE        equ    (1024 * 8)              ; ブートコードのサイズ
     3                              <1>     SECT_SIZE        equ    (512)                   ; セクタサイズ
     4                              <1>     BOOT_SECT        equ    (BOOT_SIZE / SECT_SIZE) ; ブートプログラムのセクタ数
     5                              <1>     
     6                              <1>     E820_RECORD_SIZE equ    20                      ; 取得したメモリ情報を格納する領域サイズ
     7                              <1> 
     8                              <1>     KERNEL_LOAD      equ    0x0010_1000
     9                              <1>     KERNEL_SIZE      equ    (1024 * 8)
     2                                  %include "../include/macro.s"
     1                              <1> ; %macro <マクロ名> <引数の数>
     2                              <1> ; 1-*: 1つ以上の引数が指定されることを示す
     3                              <1> ; .nolist: マクロのリスト出力を抑止
     4                              <1> %macro  cdecl 1-*.nolist
     5                              <1> 
     6                              <1>     ; -------------------------------------------------
     7                              <1>     ; 引数リストから、呼び出し関数の引数を末尾から順にpushする
     8                              <1>     ; -------------------------------------------------
     9                              <1>     ; %rep <number>: %rep -> %endrepの間を指定回数分ループする
    10                              <1>     ; %0 - 1: 呼び出し関数への引数の数(%0は引数の数を表す。引数の数から、呼び出し関数そのものを数から引くと呼び出し関数への引数の数となる)
    11                              <1>     %rep    %0 - 1
    12                              <1>         ; 引数リストの末尾の値をpushする
    13                              <1>         ; %{-1:-1}: 引数リストの末尾を表す
    14                              <1>         push    %{-1:-1}
    15                              <1> 
    16                              <1>         ; %rotate: 引数リストを指定した数だけずらす
    17                              <1>         ; 今回は末尾から引数をpushしたいので、負の数を指定し右方向へ動かす
    18                              <1>         ; ※動作例
    19                              <1>         ; [1, 2, 3, 4] -> (%rotate -1) -> [4, 1, 2, 3]
    20                              <1>         %rotate -1
    21                              <1>     %endrep
    22                              <1> 
    23                              <1>     ; 引数リストの順番を元に戻す
    24                              <1>     %rotate - 1
    25                              <1> 
    26                              <1>     ; 関数呼び出し
    27                              <1>     call    %1
    28                              <1>     
    29                              <1>     ; 引数が与えられている場合
    30                              <1>     %if 1 < %0
    31                              <1>         ; 呼び出し関数への引数分だけスタックの破棄(スタックポインタ(SP)の調整)
    32                              <1>         ; __BITS__: ビットモード判定(実行環境に応じた値(16 or 32 or 64)が得られる)
    33                              <1>         ; ビットモードを3ビット分右にシフト(1/8)すると、バイトサイズが得られる
    34                              <1>         ; * 16ビットモード: 2バイト
    35                              <1>         ; * 32ビットモード: 4バイト
    36                              <1>         ; * 64ビットモード: 8バイト
    37                              <1>         add sp, (__BITS__ >> 3) * (%0 - 1)
    38                              <1>     %endif
    39                              <1> 
    40                              <1> %endmacro
    41                              <1> 
    42                              <1> struc drive
    43 00000000 <res 00000002>      <1>     .no resw 1      ; ドライブ番号
    44 00000002 <res 00000002>      <1>     .cyln resw 1    ; シリンダ
    45 00000004 <res 00000002>      <1>     .head resw 1    ; ヘッド
    46 00000006 <res 00000002>      <1>     .sect resw 1    ; セクタ
    47                              <1> endstruc
     3                                  
     4                                      ORG KERNEL_LOAD
     5                                  
     6                                  [BITS 32]
     7                                  ; エントリポイント
     8                                  kernel:
     9                                      ; 処理終了
    10 00000000 EBFE                        jmp $
    11                                  
    12                                  ; パディング
    13 00000002 00<rept>                        times KERNEL_SIZE - ($ - $$) db 0
    14                                  
